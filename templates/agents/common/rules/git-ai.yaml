name: git-ai-mcp
version: "2.0.0"
description: |
  Agent 使用 git-ai MCP 工具的行为约束。
  确保 Agent 高效、安全、准确地帮助开发者理解和修改代码。

must_follow:
  - id: explicit_path
    severity: error
    rule: |
      每次 MCP 工具调用必须显式传 path 参数。
      禁止依赖进程状态或工作目录隐式推断仓库位置。

  - id: check_index_first
    severity: error
    rule: |
      使用 search_symbols、semantic_search、ast_graph_* 前，
      必须先调用 check_index 确认索引就绪。
      索引不兼容时必须重建，禁止在索引缺失时进行符号搜索。

  - id: understand_before_modify
    severity: error
    rule: |
      修改代码前必须先理解现有实现。
      流程：search_symbols 定位 → read_file 精读 → ast_graph_callers 确认影响范围 → 修改。
      禁止直接修改未读过的文件。

  - id: use_dsr_for_history
    severity: warning
    rule: |
      追溯符号变更历史必须使用 dsr_symbol_evolution。
      禁止手动解析 git log 或 diff 来推断符号变更。

  - id: repo_map_before_large_change
    severity: warning
    rule: |
      大型变更前必须使用 repo_map 确认影响范围。
      了解项目结构、关键文件、主要符号后再规划修改。

  - id: respect_dsr_risk
    severity: warning
    rule: |
      DSR 报告 risk_level 为 high 的变更必须谨慎对待。
      涉及 delete、rename 操作的变更需要额外审查。

recommended:
  - id: prefer_semantic_search
    rule: |
      理解功能意图时优先使用 semantic_search，
      精确定位时使用 search_symbols。

  - id: use_call_chain_for_complex_flow
    rule: |
      复杂调用链路使用 ast_graph_chain 追踪，
      避免手动递归查找 callers/callees。

  - id: incremental_dsr_generation
    rule: |
      需要历史分析时，按需生成 DSR，
      避免一次性生成所有历史提交的 DSR。

  - id: attach_repo_map_for_context
    rule: |
      复杂查询可附带 repo_map，
      帮助建立全局上下文。

prohibited:
  - action: "假设符号位置而不搜索"
    reason: "必须通过 search_symbols 或 semantic_search 确认符号位置"

  - action: "直接修改未读过的文件"
    reason: "必须先 read_file 理解实现，避免破坏性变更"

  - action: "手动解析 git 历史"
    reason: "必须使用 dsr_symbol_evolution 追溯符号变更"

  - action: "在索引缺失时进行符号搜索"
    reason: "索引是符号搜索的前提，缺失时必须重建"

  - action: "忽略 DSR 风险等级"
    reason: "high 风险变更需要额外审查，不能盲目应用"

  - action: "省略 path 参数"
    reason: "每次调用必须显式传 path，保证原子性和可复现性"

tool_usage_constraints:
  repo_map:
    when: "首次接触仓库、大型变更前"
    must_pass: ["path"]

  check_index:
    when: "任何符号搜索前"
    must_pass: ["path"]

  rebuild_index:
    when: "索引不兼容或缺失时"
    must_pass: ["path"]
    note: "可能耗时较长，大型仓库谨慎使用"

  search_symbols:
    when: "按名称查找符号"
    must_pass: ["path", "query"]
    precheck: "check_index 必须通过"

  semantic_search:
    when: "按语义查找代码"
    must_pass: ["path", "query"]
    precheck: "check_index 必须通过"

  ast_graph_callers:
    when: "查找调用者"
    must_pass: ["path", "name"]
    precheck: "check_index 必须通过"

  ast_graph_callees:
    when: "查找被调用者"
    must_pass: ["path", "name"]
    precheck: "check_index 必须通过"

  ast_graph_chain:
    when: "追踪调用链"
    must_pass: ["path", "name"]
    precheck: "check_index 必须通过"

  dsr_context:
    when: "了解仓库 Git 状态和 DSR 情况"
    must_pass: ["path"]

  dsr_generate:
    when: "为特定提交生成 DSR"
    must_pass: ["path", "commit"]

  dsr_symbol_evolution:
    when: "追溯符号变更历史"
    must_pass: ["path", "symbol"]
    precheck: "相关提交的 DSR 必须已生成"

  read_file:
    when: "精读代码"
    must_pass: ["path", "file"]
    note: "建议结合 start_line/end_line 限制范围"
